#!/bin/bash

# =============================================================================
# Antigravity Kit (agk) - AI Agent Management Tool
# =============================================================================

VERSION="1.0.0"

# Configuration
CACHE_DIR="$HOME/.antigravity/cache"
REPO_URL="git@github.com:Dang-Hai-Tran/antigravity-kit.git"
REPO_NAME="antigravity-kit"
SOURCE_AGENT_DIR="$CACHE_DIR/$REPO_NAME/.agent"
TARGET_AGENT_DIR="./.agent"

# Preserved folders (not overwritten during update)
PRESERVED_FOLDERS=("docs")

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# =============================================================================
# Logging Functions
# =============================================================================

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# =============================================================================
# Helper Functions
# =============================================================================

# Portable sed in-place edit (works on both macOS and Linux)
sed_inplace() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "$@"
    else
        sed -i "$@"
    fi
}

# Cleanup temp files on exit
cleanup() {
    rm -rf /tmp/.agent_*_backup_$$ 2>/dev/null
}
trap cleanup EXIT

# Check if we have internet connectivity
check_connectivity() {
    if ! git ls-remote "$REPO_URL" &>/dev/null; then
        return 1
    fi
    return 0
}

# =============================================================================
# Core Functions
# =============================================================================

# Ensure cache directory exists and repo is up to date
sync_repo() {
    local offline_mode="${1:-false}"

    mkdir -p "$CACHE_DIR"

    if [ -d "$CACHE_DIR/$REPO_NAME/.git" ]; then
        if [ "$offline_mode" = "true" ]; then
            log_info "Using cached repository (offline mode)..."
            return 0
        fi

        log_info "Updating cached repository..."
        if ! (cd "$CACHE_DIR/$REPO_NAME" && git fetch origin && git reset --hard origin/main); then
            log_warn "Failed to update from remote. Using cached version."
            return 0
        fi
    else
        if [ "$offline_mode" = "true" ]; then
            log_error "No cached repository found. Cannot run in offline mode."
            exit 1
        fi

        log_info "Cloning repository to cache..."
        rm -rf "$CACHE_DIR/$REPO_NAME"
        if ! git clone "$REPO_URL" "$CACHE_DIR/$REPO_NAME"; then
            log_error "Failed to clone repository."
            exit 1
        fi
    fi

    log_success "Repository synced successfully."
}

# Backup preserved folders
backup_preserved() {
    for folder in "${PRESERVED_FOLDERS[@]}"; do
        if [ -d "$TARGET_AGENT_DIR/$folder" ]; then
            log_info "Preserving $folder folder..."
            mv "$TARGET_AGENT_DIR/$folder" "/tmp/.agent_${folder}_backup_$$"
        fi
    done
}

# Restore preserved folders
restore_preserved() {
    for folder in "${PRESERVED_FOLDERS[@]}"; do
        if [ -d "/tmp/.agent_${folder}_backup_$$" ]; then
            rm -rf "$TARGET_AGENT_DIR/$folder"
            mv "/tmp/.agent_${folder}_backup_$$" "$TARGET_AGENT_DIR/$folder"
            log_info "Restored $folder folder"
        fi
    done
}

# Add .agent to git exclude
add_git_exclude() {
    if [ -d ".git" ]; then
        EXCLUDE_FILE=".git/info/exclude"
        if ! grep -q "^\.agent$" "$EXCLUDE_FILE" 2>/dev/null; then
            echo ".agent" >> "$EXCLUDE_FILE"
            log_info "Added .agent to git exclude"
        fi
    fi
}

# Remove .agent from git exclude
remove_git_exclude() {
    if [ -d ".git" ]; then
        EXCLUDE_FILE=".git/info/exclude"
        if [ -f "$EXCLUDE_FILE" ] && grep -q "^\.agent$" "$EXCLUDE_FILE"; then
            sed_inplace '/^\.agent$/d' "$EXCLUDE_FILE"
            log_info "Removed .agent from git exclude"
        fi
    fi
}

# =============================================================================
# Commands
# =============================================================================

# Install command
cmd_install() {
    local force=false
    local offline=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force) force=true; shift ;;
            --offline) offline=true; shift ;;
            *) shift ;;
        esac
    done

    if [ -d "$TARGET_AGENT_DIR" ]; then
        if [ "$force" = "true" ]; then
            log_warn "Force mode: removing existing .agent folder..."
            rm -rf "$TARGET_AGENT_DIR"
        else
            log_error ".agent folder already exists. Use 'agk update' or 'agk install --force'."
            exit 1
        fi
    fi

    sync_repo "$offline"

    log_info "Installing .agent folder..."
    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
    add_git_exclude
    log_success ".agent installed successfully!"
}

# Update command
cmd_update() {
    local offline=false
    local dry_run=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --offline) offline=true; shift ;;
            --dry-run) dry_run=true; shift ;;
            *) shift ;;
        esac
    done

    sync_repo "$offline"

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_info ".agent folder not found. Starting fresh installation..."
        cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
        add_git_exclude
        log_success ".agent installed successfully!"
        return
    fi

    if [ "$dry_run" = "true" ]; then
        log_info "Dry run - showing what would change:"
        diff -r --brief "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" 2>/dev/null | grep -v "\.git" | grep -vE "/($(IFS='|'; echo "${PRESERVED_FOLDERS[*]}"))" || echo "No changes detected."
        return
    fi

    log_info "Updating .agent folder..."
    backup_preserved
    rm -rf "$TARGET_AGENT_DIR"
    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
    restore_preserved
    log_success ".agent updated successfully!"
}

# Status command
cmd_status() {
    local offline=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --offline) offline=true; shift ;;
            *) shift ;;
        esac
    done

    sync_repo "$offline"

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder not found locally."
        exit 1
    fi

    log_info "Checking for updates..."

    # Build exclude pattern for preserved folders
    local exclude_pattern=""
    for folder in "${PRESERVED_FOLDERS[@]}"; do
        exclude_pattern="$exclude_pattern -x $folder"
    done

    # Compare excluding preserved folders and .DS_Store files
    local diff_output
    diff_output=$(diff -r --brief "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" 2>/dev/null | grep -v "\.git" | grep -v "\.DS_Store" | grep -vE "/($(IFS='|'; echo "${PRESERVED_FOLDERS[*]}"))")

    if [ -z "$diff_output" ]; then
        log_success "Your .agent folder is up to date."
    else
        echo -e "${BLUE}[INFO]${NC} Updates are available. Run 'agk update' to apply them."
        echo "Changes:"
        echo "$diff_output"
    fi
}

# Remove command
cmd_remove() {
    local force=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force) force=true; shift ;;
            *) shift ;;
        esac
    done

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder not found."
        exit 1
    fi

    if [ "$force" != "true" ]; then
        echo -e "${RED}WARNING: This will permanently delete the .agent folder.${NC}"
        read -p "Are you sure? (y/N): " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            log_info "Operation cancelled."
            return
        fi
    fi

    rm -rf "$TARGET_AGENT_DIR"
    remove_git_exclude
    log_success ".agent removed successfully!"
}

# Version command
cmd_version() {
    echo "agk version $VERSION"

    if [ -d "$CACHE_DIR/$REPO_NAME/.git" ]; then
        local commit
        commit=$(cd "$CACHE_DIR/$REPO_NAME" && git rev-parse --short HEAD 2>/dev/null)
        if [ -n "$commit" ]; then
            echo "Cache commit: $commit"
        fi
    fi
}

# =============================================================================
# Usage & Help
# =============================================================================

show_help() {
    cat << EOF
Antigravity Kit v$VERSION - AI Agent Management Tool

Usage: agk <command> [options]

Commands:
  install   Install .agent folder into current directory
  update    Update .agent folder to latest version
  status    Check if updates are available
  remove    Remove .agent folder
  version   Show version information

Options:
  -f, --force    Force operation (skip confirmations)
  --offline      Use cached repository (no network)
  --dry-run      Show what would change (update only)
  -h, --help     Show this help message

Examples:
  agk install              # Install .agent folder
  agk install --force      # Overwrite existing .agent
  agk update               # Update to latest version
  agk update --dry-run     # Preview changes
  agk update --offline     # Update from cache only
  agk status               # Check for updates
  agk remove               # Remove with confirmation
  agk remove --force       # Remove without confirmation

Preserved folders (not overwritten during update):
  ${PRESERVED_FOLDERS[*]}

EOF
}

# =============================================================================
# Main
# =============================================================================

main() {
    case "$1" in
        install)
            shift; cmd_install "$@"
            ;;
        update)
            shift; cmd_update "$@"
            ;;
        status)
            shift; cmd_status "$@"
            ;;
        remove)
            shift; cmd_remove "$@"
            ;;
        version|-v|--version)
            cmd_version
            ;;
        help|-h|--help)
            show_help
            ;;
        *)
            show_help
            exit 1
            ;;
    esac
}

main "$@"
