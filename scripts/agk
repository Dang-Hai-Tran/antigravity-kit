#!/bin/bash

# Configuration
CACHE_DIR="$HOME/.antigravity/cache"
REPO_URL="git@github.com:Dang-Hai-Tran/antigravity-kit.git"
REPO_NAME="antigravity-kit"
SOURCE_AGENT_DIR="$CACHE_DIR/$REPO_NAME/.agent"
TARGET_AGENT_DIR="./.agent"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ensure cache directory exists and repo is up to date
sync_repo() {
    mkdir -p "$CACHE_DIR"
    
    if [ -d "$CACHE_DIR/$REPO_NAME" ]; then
        log_info "Updating cached repository..."
        cd "$CACHE_DIR/$REPO_NAME" || exit
        git pull origin main
    else
        log_info "Cloning repository to cache..."
        cd "$CACHE_DIR" || exit
        git clone "$REPO_URL"
    fi
    
    if [ $? -ne 0 ]; then
        log_error "Failed to sync repository."
        exit 1
    fi
}

# Install command
install_agent() {
    sync_repo

    if [ -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder already exists. Use 'agk update' to overwrite."
        exit 1
    fi

    log_info "Installing .agent folder..."
    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
    log_success ".agent installed successfully!"
}

# Update command
update_agent() {
    sync_repo

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_info ".agent folder not found. Starting fresh installation..."
    else
        log_info "Updating .agent folder..."
        # Backup? Maybe not needed for simple update, but good practice.
        # For now, just recursive copy/overwrite.
    fi

    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
    log_success ".agent updated successfully!"
}

# Status command
status_agent() {
    sync_repo

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder not found locally."
        exit 1
    fi

    log_info "Checking for updates..."
    if diff -r -q "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" > /dev/null; then
        log_success "Your .agent folder is up to date."
    else
        echo -e "${BLUE}[INFO]${NC} Updates are available. Run 'agk update' to apply them."
        echo "Changes:"
        diff -r --brief "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" | grep -v "\.git" # Filter git stuff if any, though source shouldn't have it inside .agent
    fi
}

# Usage
usage() {
    echo "Usage: $0 {install|update|status}"
    exit 1
}

# Main logic
case "$1" in
    install)
        install_agent
        ;;
    update)
        update_agent
        ;;
    status)
        status_agent
        ;;
    *)
        usage
        ;;
esac
