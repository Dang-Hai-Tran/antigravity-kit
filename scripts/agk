#!/bin/bash

# Configuration
CACHE_DIR="$HOME/.antigravity/cache"
REPO_URL="git@github.com:Dang-Hai-Tran/antigravity-kit.git"
REPO_NAME="antigravity-kit"
SOURCE_AGENT_DIR="$CACHE_DIR/$REPO_NAME/.agent"
TARGET_AGENT_DIR="./.agent"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ensure cache directory exists and repo is up to date
sync_repo() {
    mkdir -p "$CACHE_DIR"

    if [ -d "$CACHE_DIR/$REPO_NAME/.git" ]; then
        log_info "Updating cached repository..."
        if ! (cd "$CACHE_DIR/$REPO_NAME" && git fetch origin && git reset --hard origin/main); then
            log_error "Failed to update repository."
            exit 1
        fi
    else
        log_info "Cloning repository to cache..."
        # Remove if exists but corrupted (no .git)
        rm -rf "$CACHE_DIR/$REPO_NAME"
        if ! git clone "$REPO_URL" "$CACHE_DIR/$REPO_NAME"; then
            log_error "Failed to clone repository."
            exit 1
        fi
    fi

    log_success "Repository synced successfully."
}

# Install command
install_agent() {
    sync_repo

    if [ -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder already exists. Use 'agk update' to overwrite."
        exit 1
    fi

    log_info "Installing .agent folder..."
    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"

    # Add .agent to git exclude (local only)
    if [ -d ".git" ]; then
        EXCLUDE_FILE=".git/info/exclude"
        if ! grep -q "^\.agent$" "$EXCLUDE_FILE" 2>/dev/null; then
            echo ".agent" >> "$EXCLUDE_FILE"
            log_info "Added .agent to git exclude"
        fi
    fi

    log_success ".agent installed successfully!"
}

# Update command
update_agent() {
    sync_repo

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_info ".agent folder not found. Starting fresh installation..."
    else
        log_info "Updating .agent folder..."
        rm -rf "$TARGET_AGENT_DIR"
    fi

    cp -R "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR"
    log_success ".agent updated successfully!"
}

# Status command
status_agent() {
    sync_repo

    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder not found locally."
        exit 1
    fi

    log_info "Checking for updates..."
    if diff -r -q "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" > /dev/null; then
        log_success "Your .agent folder is up to date."
    else
        echo -e "${BLUE}[INFO]${NC} Updates are available. Run 'agk update' to apply them."
        echo "Changes:"
        diff -r --brief "$SOURCE_AGENT_DIR" "$TARGET_AGENT_DIR" | grep -v "\.git" # Filter git stuff if any, though source shouldn't have it inside .agent
    fi
}

# Remove command
remove_agent() {
    if [ ! -d "$TARGET_AGENT_DIR" ]; then
        log_error ".agent folder not found."
        exit 1
    fi

    echo -e "${RED}WARNING: This will permanently delete the .agent folder.${NC}"
    read -p "Are you sure? (y/N): " confirm

    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        rm -rf "$TARGET_AGENT_DIR"

        # Remove .agent from git exclude if present
        if [ -d ".git" ]; then
            EXCLUDE_FILE=".git/info/exclude"
            if [ -f "$EXCLUDE_FILE" ] && grep -q "^\.agent$" "$EXCLUDE_FILE"; then
                sed -i '' '/^\.agent$/d' "$EXCLUDE_FILE"
                log_info "Removed .agent from git exclude"
            fi
        fi

        log_success ".agent removed successfully!"
    else
        log_info "Operation cancelled."
    fi
}

# Usage
usage() {
    echo "Antigravity Kit - AI Agent Management Tool"
    echo ""
    echo "Usage: agk <command>"
    echo ""
    echo "Commands:"
    echo "  install   Install .agent folder (fails if already exists)"
    echo "  update    Update .agent folder to latest version"
    echo "  status    Check if updates are available"
    echo "  remove    Remove .agent folder (with confirmation)"
    echo ""
    exit 1
}

# Main logic
case "$1" in
    install)
        install_agent
        ;;
    update)
        update_agent
        ;;
    status)
        status_agent
        ;;
    remove)
        remove_agent
        ;;
    *)
        usage
        ;;
esac
